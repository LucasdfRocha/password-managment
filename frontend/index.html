<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciador de Senhas</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #1a202c;
      line-height: 1.6;
    }

    header {
      background: rgba(255, 255, 255, 0.95);
      padding: 1.25rem 2rem;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    #status {
      font-size: 0.875rem;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 8px;
    }

    #status.ok {
      color: #047857;
      background: #d1fae5;
    }

    #status.error {
      color: #dc2626;
      background: #fee2e2;
    }

    main {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 10px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .login-card {
      max-width: 450px;
      margin: 4rem auto;
    }

    .card h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: #1a202c;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #4a5568;
    }

    input[type="text"],
    input[type="password"],
    input[type="number"],
    input[type="datetime-local"] {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 0.938rem;
      background: #f8fafc;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      font-size: 0.875rem;
      color: #4a5568;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 8px;
    }

    .checkbox-label:hover {
      background: #f7fafc;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 0.5rem;
      cursor: pointer;
      accent-color: #667eea;
    }

    button {
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      border: none;
      font-size: 0.938rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
    }

    button.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button.primary:hover {
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }

    button.secondary {
      background: #718096;
      color: white;
    }

    button.secondary:hover {
      background: #4a5568;
    }

    button.danger {
      background: #ef4444;
      color: white;
    }

    button.danger:hover {
      background: #dc2626;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    th {
      background: #f8fafc;
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: #4a5568;
      border-bottom: 2px solid #e2e8f0;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid #f1f5f9;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr {
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    .password-value {
      font-family: 'Monaco', 'Courier New', monospace;
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      display: inline-block;
      margin-top: 0.5rem;
      border: 1px solid #e2e8f0;
      font-size: 0.938rem;
      letter-spacing: 0.5px;
    }

    .small-text {
      font-size: 0.813rem;
      color: #718096;
    }

    .row-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .row-actions button {
      padding: 0.5rem 1rem;
      font-size: 0.813rem;
    }

    .hidden {
      display: none;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge.weak {
      background: #fee2e2;
      color: #dc2626;
    }

    .badge.medium {
      background: #fef3c7;
      color: #d97706;
    }

    .badge.strong {
      background: #d1fae5;
      color: #047857;
    }

    .form-section {
      border: 2px solid #f1f5f9;
      border-radius: 12px;
      padding: 1.5rem;
      background: #fafbfc;
      margin-bottom: 2rem;
    }

    .password-row td {
      background: #f8fafc;
      padding: 1.5rem;
    }

    .copy-btn {
      margin-left: 0.5rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.813rem;
      background: #10b981;
      color: white;
    }

    .copy-btn:hover {
      background: #059669;
    }

    .copy-btn.copied {
      background: #6366f1;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #94a3b8;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      opacity: 0.3;
    }

    .search-box {
      margin-bottom: 1.5rem;
    }

    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      background: #f8fafc url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cpath d='m21 21-4.35-4.35'%3E%3C/path%3E%3C/svg%3E") no-repeat 0.75rem center;
    }

    .password-strength-meter {
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      margin-top: 0.5rem;
      overflow: hidden;
    }

    .password-strength-bar {
      height: 100%;
      border-radius: 3px;
    }

    .show-password-btn {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      padding: 0.5rem;
      cursor: pointer;
      color: #718096;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .show-password-btn:hover {
      color: #4a5568;
    }

    .password-input-wrapper {
      position: relative;
    }

    @media (max-width: 768px) {
      header {
        padding: 1rem;
      }

      .header-content h1 {
        font-size: 1.25rem;
      }

      .card {
        padding: 1.5rem;
      }

      .checkbox-group {
        grid-template-columns: 1fr;
      }

      .table-container {
        font-size: 0.813rem;
      }

      th, td {
        padding: 0.75rem 0.5rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>üîê Gerenciador de Senhas</h1>
      <span id="status"></span>
    </div>
  </header>

  <main>
    <!-- Login -->
    <section id="login-section">
      <div class="card login-card">
        <h2>Login com Senha Mestra</h2>
        <div class="form-group">
          <label for="master-password">Senha mestra</label>
          <div class="password-input-wrapper">
            <input type="password" id="master-password" placeholder="Digite sua senha mestra">
            <button type="button" class="show-password-btn" id="toggle-master-password" title="Mostrar/ocultar senha">Mostrar</button>
          </div>
        </div>
        <button class="primary" id="btn-login" style="width: 100%;">Entrar</button>
      </div>
    </section>

    <!-- App -->
    <section id="app-section" class="hidden">
      <div class="card">
        <div class="top-bar">
          <h2>Bem-vindo! üëã</h2>
          <button class="secondary" id="btn-logout">Sair</button>
        </div>

        <!-- Form de cria√ß√£o de senha -->
        <div class="form-section">
          <h2 style="font-size: 1.25rem; margin-bottom: 1rem;">‚ú® Criar nova senha</h2>
          <form id="form-create-password">
            <div class="form-group">
              <label for="title">T√≠tulo</label>
              <input type="text" id="title" required placeholder="Ex.: Gmail pessoal">
            </div>

            <div class="form-group">
              <label for="site">Site / Servi√ßo</label>
              <input type="text" id="site" required placeholder="Ex.: https://mail.google.com">
            </div>

            <div class="form-group">
              <label for="length">Tamanho da senha (se for gerada)</label>
              <input type="number" id="length" min="4" max="128" value="16">
            </div>

            <div class="form-group">
              <label>Caracteres inclu√≠dos</label>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="use-uppercase" checked>
                  Mai√∫sculas (A-Z)
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="use-lowercase" checked>
                  Min√∫sculas (a-z)
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="use-digits" checked>
                  D√≠gitos (0-9)
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="use-special" checked>
                  Especiais (!@#$...)
                </label>
              </div>
            </div>

            <div class="form-group">
              <label for="expiration-date">Data de expira√ß√£o (opcional)</label>
              <input type="datetime-local" id="expiration-date">
            </div>

            <div class="form-group">
              <label for="custom-password">Senha customizada (opcional)</label>
              <input type="text" id="custom-password" placeholder="Deixe vazio para gerar automaticamente">
              <div class="password-strength-meter">
                <div class="password-strength-bar" id="password-strength-bar"></div>
              </div>
              <div id="password-strength-text" class="small-text" style="margin-top: 0.25rem;"></div>
            </div>

            <button type="submit" class="primary">Criar senha</button>
          </form>
        </div>
      </div>

      <!-- Lista de senhas -->
      <div class="card">
        <h2>üîë Senhas salvas</h2>
        <p class="small-text" style="margin-bottom: 1.5rem;">
          A senha descriptografada s√≥ √© mostrada quando voc√™ clica em <strong>Ver</strong>.
        </p>
        
        <div class="search-box">
          <input type="text" id="search-passwords" placeholder="Buscar senhas por t√≠tulo ou site...">
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>T√≠tulo</th>
                <th>Site</th>
                <th>Seguran√ßa</th>
                <th>Expira em</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="passwords-table-body">
              <!-- Linhas preenchidas via JS -->
            </tbody>
          </table>
          <div id="empty-state" class="empty-state hidden">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            <p>Nenhuma senha encontrada</p>
            <p class="small-text">Crie sua primeira senha usando o formul√°rio acima</p>
          </div>
        </div>
      </div>
            <!-- Wallet -->
      <div class="card" style="margin-top: 1.5rem;">
        <h2>üì¶ Wallet (Backup Remoto)</h2>
        <p class="small-text" style="margin-bottom: 1rem;">
          Exporte todas as suas senhas criptografadas para um arquivo ou importe de um arquivo existente.<br>
          O servidor nunca v√™ suas senhas em texto puro.
        </p>

        <div style="display:flex; gap:10px;">
          <button id="btn-wallet-export" class="secondary">Exportar Wallet</button>

          <input type="file" id="wallet-file-input" accept="application/json" style="display:none;">
          <button id="btn-wallet-import" class="secondary">Importar Wallet</button>
        </div>
      </div>

    </section>
  </main>

  <script>
  // ===== Configura√ß√£o =====
  const API_BASE = "http://localhost:8000/api";

  let sessionToken = null;
  let masterPasswordPlain = null; // *** NOVO: guardar a master s√≥ no front

  const statusEl = document.getElementById('status');
  const loginSection = document.getElementById('login-section');
  const appSection = document.getElementById('app-section');

  const masterPasswordInput = document.getElementById('master-password');
  const btnLogin = document.getElementById('btn-login');
  const btnLogout = document.getElementById('btn-logout');

  const formCreatePassword = document.getElementById('form-create-password');
  const tbodyPasswords = document.getElementById('passwords-table-body');
  const searchInput = document.getElementById('search-passwords');
  const emptyState = document.getElementById('empty-state');
  const customPasswordInput = document.getElementById('custom-password');
  const passwordStrengthBar = document.getElementById('password-strength-bar');
  const passwordStrengthText = document.getElementById('password-strength-text');

  let allPasswords = [];

  // ===== Helpers de criptografia (NOVOS) =====

  function bytesToBase64(bytes) {
    let binary = "";
    for (let i = 0; i < bytes.length; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  }

  function base64ToBytes(base64) {
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    return bytes;
  }

  async function deriveAesKey(masterPassword, salt, iterations = 300000) {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
      "raw",
      enc.encode(masterPassword),
      { name: "PBKDF2" },
      false,
      ["deriveKey"]
    );

    const key = await crypto.subtle.deriveKey(
      {
        name: "PBKDF2",
        salt: salt,
        iterations: iterations,
        hash: "SHA-256",
      },
      keyMaterial,
      { name: "AES-GCM", length: 256 },
      false,
      ["encrypt", "decrypt"]
    );

    return key;
  }

  async function encryptWithMasterPassword(plaintext, masterPassword) {
    const enc = new TextEncoder();
    const plaintextBytes = enc.encode(plaintext);

    const SALT_SIZE = 16;
    const NONCE_SIZE = 12;
    const TAG_SIZE = 16;

    const salt = crypto.getRandomValues(new Uint8Array(SALT_SIZE));
    const nonce = crypto.getRandomValues(new Uint8Array(NONCE_SIZE));
    const key = await deriveAesKey(masterPassword, salt);

    const cipherBuffer = await crypto.subtle.encrypt(
      {
        name: "AES-GCM",
        iv: nonce,
        tagLength: 128,
      },
      key,
      plaintextBytes
    );

    const cipherBytes = new Uint8Array(cipherBuffer);

    // WebCrypto retorna ciphertext || tag
    const ciphertext = cipherBytes.slice(0, cipherBytes.length - TAG_SIZE);
    const tag = cipherBytes.slice(cipherBytes.length - TAG_SIZE);

    const blob = new Uint8Array(
      salt.length + nonce.length + tag.length + ciphertext.length
    );

    blob.set(salt, 0);
    blob.set(nonce, salt.length);
    blob.set(tag, salt.length + nonce.length);
    blob.set(ciphertext, salt.length + nonce.length + tag.length);

    return bytesToBase64(blob);
  }

  async function decryptWithMasterPassword(base64Blob, masterPassword) {
    const blob = base64ToBytes(base64Blob);

    const SALT_SIZE = 16;
    const NONCE_SIZE = 12;
    const TAG_SIZE = 16;

    let offset = 0;
    const salt = blob.slice(offset, offset + SALT_SIZE);
    offset += SALT_SIZE;

    const nonce = blob.slice(offset, offset + NONCE_SIZE);
    offset += NONCE_SIZE;

    const tag = blob.slice(offset, offset + TAG_SIZE);
    offset += TAG_SIZE;

    const ciphertext = blob.slice(offset);

    const key = await deriveAesKey(masterPassword, salt);

    const cipherPlusTag = new Uint8Array(ciphertext.length + tag.length);
    cipherPlusTag.set(ciphertext, 0);
    cipherPlusTag.set(tag, ciphertext.length);

    const plainBuffer = await crypto.subtle.decrypt(
      {
        name: "AES-GCM",
        iv: nonce,
        tagLength: 128,
      },
      key,
      cipherPlusTag
    );

    return new TextDecoder().decode(plainBuffer);
  }

  function generatePassword(length, useUppercase, useLowercase, useDigits, useSpecial) {
    const UPPERCASE = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const LOWERCASE = "abcdefghijklmnopqrstuvwxyz";
    const DIGITS = "0123456789";
    const SPECIAL = "!@#$%^&*()_+-=[]{}|;:,.<>?";

    let charset = "";
    if (useUppercase) charset += UPPERCASE;
    if (useLowercase) charset += LOWERCASE;
    if (useDigits) charset += DIGITS;
    if (useSpecial) charset += SPECIAL;

    if (!charset) {
      throw new Error("Pelo menos um tipo de caractere deve ser selecionado.");
    }

    const passwordChars = [];

    if (useUppercase) passwordChars.push(UPPERCASE[Math.floor(Math.random() * UPPERCASE.length)]);
    if (useLowercase) passwordChars.push(LOWERCASE[Math.floor(Math.random() * LOWERCASE.length)]);
    if (useDigits) passwordChars.push(DIGITS[Math.floor(Math.random() * DIGITS.length)]);
    if (useSpecial) passwordChars.push(SPECIAL[Math.floor(Math.random() * SPECIAL.length)]);

    while (passwordChars.length < length) {
      const idx = Math.floor(Math.random() * charset.length);
      passwordChars.push(charset[idx]);
    }

    for (let i = passwordChars.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [passwordChars[i], passwordChars[j]] = [passwordChars[j], passwordChars[i]];
    }

    return passwordChars.join("");
  }

  // ===== Helpers =====
  function setStatus(message, type = "ok") {
    statusEl.textContent = message;
    statusEl.className = "";
    if (type === "ok") statusEl.classList.add("ok");
    if (type === "error") statusEl.classList.add("error");
  }

  function showApp() {
    loginSection.classList.add('hidden');
    appSection.classList.remove('hidden');
  }

  function showLogin() {
    appSection.classList.add('hidden');
    loginSection.classList.remove('hidden');
    tbodyPasswords.innerHTML = "";
    allPasswords = [];
    searchInput.value = "";
  }

  async function apiRequest(path, options = {}) {
    const url = API_BASE + path;
    const headers = options.headers || {};
    if (sessionToken) {
      headers['X-Session-Token'] = sessionToken;
    }
    return fetch(url, { ...options, headers });
  }

  function formatDate(isoString) {
    if (!isoString) return "-";
    try {
      const d = new Date(isoString);
      return d.toLocaleString('pt-BR');
    } catch (e) {
      return isoString;
    }
  }

  function getEntropyBadge(level) {
    const levelLower = level.toLowerCase();
    if (levelLower.includes('fraca') || levelLower.includes('weak')) {
      return 'weak';
    } else if (levelLower.includes('m√©dia') || levelLower.includes('medium') || levelLower.includes('moderate')) {
      return 'medium';
    } else {
      return 'strong';
    }
  }

  function calculatePasswordStrength(password) {
    if (!password) return { strength: 0, text: '', color: '' };
    
    let strength = 0;
    
    if (password.length >= 8) strength += 1;
    if (password.length >= 12) strength += 1;
    if (password.length >= 16) strength += 1;
    
    if (/[a-z]/.test(password)) strength += 1;
    if (/[A-Z]/.test(password)) strength += 1;
    if (/[0-9]/.test(password)) strength += 1;
    if (/[^a-zA-Z0-9]/.test(password)) strength += 1;
    
    const normalized = Math.min(strength / 7, 1);
    let text = '';
    let color = '';
    
    if (normalized < 0.3) {
      text = 'Muito fraca';
      color = '#ef4444';
    } else if (normalized < 0.5) {
      text = 'Fraca';
      color = '#f59e0b';
    } else if (normalized < 0.7) {
      text = 'M√©dia';
      color = '#eab308';
    } else if (normalized < 0.9) {
      text = 'Forte';
      color = '#10b981';
    } else {
      text = 'Muito forte';
      color = '#059669';
    }
    
    return { strength: normalized * 100, text, color };
  }

  async function copyToClipboard(text, button) {
    try {
      await navigator.clipboard.writeText(text);
      const originalText = button.textContent;
      button.textContent = '‚úì Copiado!';
      button.classList.add('copied');
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('copied');
      }, 2000);
    } catch (e) {
      console.error('Erro ao copiar:', e);
      setStatus('Erro ao copiar para √°rea de transfer√™ncia', 'error');
    }
  }

  function updateEmptyState() {
    const hasRows = tbodyPasswords.children.length > 0;
    if (hasRows) {
      emptyState.classList.add('hidden');
    } else {
      emptyState.classList.remove('hidden');
    }
  }

  function filterPasswords() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    tbodyPasswords.innerHTML = ''; // garante que limpa sempre

    if (!searchTerm) {
      allPasswords.forEach(entry => addPasswordRow(entry));
      updateEmptyState();
      return;
    }
    
    const filtered = allPasswords.filter(entry => 
      entry.title.toLowerCase().includes(searchTerm) ||
      entry.site.toLowerCase().includes(searchTerm)
    );
    
    filtered.forEach(entry => addPasswordRow(entry));
    updateEmptyState();
  }

  // ===== Login / Logout =====
  document.getElementById('toggle-master-password').addEventListener('click', () => {
    const input = masterPasswordInput;
    const button = document.getElementById('toggle-master-password');
    if (input.type === 'password') {
      input.type = 'text';
      button.textContent = 'Ocultar';
    } else {
      input.type = 'password';
      button.textContent = 'Mostrar';
    }
  });

  masterPasswordInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      btnLogin.click();
    }
  });

  btnLogin.addEventListener('click', async () => {
    const masterPassword = masterPasswordInput.value.trim();
    if (!masterPassword) {
      setStatus("Digite a senha mestra.", "error");
      return;
    }

    btnLogin.disabled = true;
    setStatus("Fazendo login...");

    try {
      const resp = await fetch(API_BASE + "/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ master_password: masterPassword })
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.detail || "Falha no login");
      }

      const data = await resp.json();
      sessionToken = data.token;

      // *** NOVO: guardar master no front
      masterPasswordPlain = masterPassword;

      setStatus("Login realizado com sucesso.");
      masterPasswordInput.value = "";
      showApp();
      await loadPasswords();
    } catch (e) {
      console.error(e);
      setStatus("Erro no login: " + e.message, "error");
    } finally {
      btnLogin.disabled = false;
    }
  });

  btnLogout.addEventListener('click', async () => {
    if (!sessionToken) {
      showLogin();
      setStatus("Sess√£o encerrada.");
      return;
    }

    try {
      await apiRequest("/auth/logout", {
        method: "POST"
      });
    } catch (e) {
      console.warn("Erro no logout (ignorado):", e);
    } finally {
      sessionToken = null;
      masterPasswordPlain = null; // *** NOVO: limpar da mem√≥ria
      showLogin();
      setStatus("Sess√£o encerrada.");
    }
  });

  // ===== CRUD de Senhas =====
  async function loadPasswords() {
    if (!sessionToken) return;

    setStatus("Carregando senhas...");
    tbodyPasswords.innerHTML = "";
    allPasswords = [];

    try {
      const resp = await apiRequest("/passwords", {
        method: "GET"
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.detail || "Erro ao listar senhas");
      }

      const data = await resp.json();
      if (!Array.isArray(data)) {
        throw new Error("Resposta inesperada do servidor.");
      }

      allPasswords = data;
      data.forEach(entry => addPasswordRow(entry));
      updateEmptyState();
      setStatus("Senhas carregadas.");
    } catch (e) {
      console.error(e);
      setStatus("Erro ao carregar senhas: " + e.message, "error");
      updateEmptyState();
    }
  }

  function addPasswordRow(entry) {
    const tr = document.createElement('tr');
    tr.dataset.id = entry.id;

    const tdId = document.createElement('td');
    tdId.textContent = entry.id;

    const tdTitle = document.createElement('td');
    tdTitle.textContent = entry.title;

    const tdSite = document.createElement('td');
    tdSite.textContent = entry.site;

    const tdEntropy = document.createElement('td');
    const badgeClass = getEntropyBadge(entry.entropy_level);
    tdEntropy.innerHTML = `
      <div>${entry.entropy} bits</div>
      <span class="badge ${badgeClass}">${entry.entropy_level}</span>
    `;

    const tdExp = document.createElement('td');
    tdExp.textContent = formatDate(entry.expiration_date);

    const tdActions = document.createElement('td');
    const actionsDiv = document.createElement('div');
    actionsDiv.className = "row-actions";

    const btnView = document.createElement('button');
    btnView.textContent = "Ver";
    btnView.className = "secondary";
    btnView.addEventListener('click', () => viewPassword(entry.id, tr));

    const btnDelete = document.createElement('button');
    btnDelete.textContent = "Excluir";
    btnDelete.className = "danger";
    btnDelete.addEventListener('click', () => deletePassword(entry.id, tr));

    actionsDiv.appendChild(btnView);
    actionsDiv.appendChild(btnDelete);
    tdActions.appendChild(actionsDiv);

    tr.appendChild(tdId);
    tr.appendChild(tdTitle);
    tr.appendChild(tdSite);
    tr.appendChild(tdEntropy);
    tr.appendChild(tdExp);
    tr.appendChild(tdActions);

    tbodyPasswords.appendChild(tr);
  }

  async function viewPassword(id, row) {
    try {
      if (!masterPasswordPlain) {
        setStatus("Senha mestra n√£o est√° dispon√≠vel no cliente.", "error");
        return;
      }

      setStatus("Carregando senha...");
      const resp = await apiRequest(`/passwords/${id}`, {
        method: "GET"
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.detail || "Erro ao obter senha");
      }

      const data = await resp.json();

      // *** NOVO: senha vem criptografada -> descriptografar no cliente
      let decrypted;
      try {
        decrypted = await decryptWithMasterPassword(data.encrypted_password, masterPasswordPlain);
      } catch (e) {
        console.error(e);
        setStatus("Erro ao descriptografar a senha no cliente: " + e.message, "error");
        return;
      }

      setStatus("Senha carregada.");

      const existing = row.nextElementSibling;
      if (existing && existing.classList.contains("password-row")) {
        existing.remove();
      }

      const tr = document.createElement('tr');
      tr.className = "password-row";

      const td = document.createElement('td');
      td.colSpan = 6;

      const escaped = decrypted.replace(/'/g, "\\'");

      td.innerHTML = `
        <div>
          <strong>Senha descriptografada (no cliente):</strong>
          <div class="password-value">
            ${decrypted}
            <button class="copy-btn" onclick="copyToClipboard('${escaped}', this)">üìã Copiar</button>
          </div>
        </div>
      `;

      tr.appendChild(td);
      row.parentNode.insertBefore(tr, row.nextSibling);

    } catch (e) {
      console.error(e);
      setStatus("Erro ao obter senha: " + e.message, "error");
    }
  }

  async function deletePassword(id, row) {
  if (!confirm("Tem certeza que deseja excluir esta senha?")) {
    return;
  }

  try {
    setStatus("Excluindo senha...");
    const resp = await apiRequest(`/passwords/${id}`, {
      method: "DELETE"
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.detail || "Erro ao deletar senha");
    }

    // pega a linha de detalhe ANTES de remover a principal
    const extra = row.nextElementSibling;
    if (extra && extra.classList.contains("password-row")) {
      extra.remove();
    }

    // remove a linha principal
    row.remove();

    // Remove do array local
    allPasswords = allPasswords.filter(p => p.id !== id);

    updateEmptyState();

    const data = await resp.json().catch(() => null);
    setStatus(data?.message || "Senha deletada com sucesso.");
  } catch (e) {
    console.error(e);
    setStatus("Erro ao deletar senha: " + e.message, "error");
  }
}


  // ===== Form de cria√ß√£o de senha =====
  formCreatePassword.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!sessionToken) {
      setStatus("Voc√™ precisa estar logado.", "error");
      return;
    }
    if (!masterPasswordPlain) {
      setStatus("Senha mestra n√£o est√° dispon√≠vel no cliente.", "error");
      return;
    }

    const title = document.getElementById('title').value.trim();
    const site = document.getElementById('site').value.trim();
    let length = parseInt(document.getElementById('length').value, 10) || 16;
    const useUppercase = document.getElementById('use-uppercase').checked;
    const useLowercase = document.getElementById('use-lowercase').checked;
    const useDigits = document.getElementById('use-digits').checked;
    const useSpecial = document.getElementById('use-special').checked;
    const expirationInput = document.getElementById('expiration-date').value;
    const customPassword = document.getElementById('custom-password').value.trim() || null;

    let plainPassword;
    if (customPassword) {
      plainPassword = customPassword;
      length = customPassword.length;
    } else {
      try {
        plainPassword = generatePassword(length, useUppercase, useLowercase, useDigits, useSpecial);
      } catch (e) {
        setStatus(e.message, "error");
        return;
      }
    }

    setStatus("Criptografando senha no cliente...");

    let encryptedBase64;
    try {
      encryptedBase64 = await encryptWithMasterPassword(plainPassword, masterPasswordPlain);
    } catch (e) {
      console.error(e);
      setStatus("Erro ao criptografar a senha no cliente: " + e.message, "error");
      return;
    }

    const payload = {
      title,
      site,
      length,
      use_uppercase: useUppercase,
      use_lowercase: useLowercase,
      use_digits: useDigits,
      use_special: useSpecial,
      expiration_date: expirationInput ? new Date(expirationInput).toISOString() : null,
      custom_password: null,                 // *** deixa de mandar texto puro
      encrypted_password: encryptedBase64    // *** NOVO
    };

    setStatus("Criando senha...");

    try {
      const resp = await apiRequest("/passwords", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.detail || "Erro ao criar senha");
      }

      const data = await resp.json();
      addPasswordRow(data);
      allPasswords.push(data);
      formCreatePassword.reset();
      document.getElementById('length').value = 16;
      document.getElementById('use-uppercase').checked = true;
      document.getElementById('use-lowercase').checked = true;
      document.getElementById('use-digits').checked = true;
      document.getElementById('use-special').checked = true;
      passwordStrengthBar.style.width = '0%';
      passwordStrengthText.textContent = '';
      updateEmptyState();
      setStatus("Senha criada com sucesso.");
    } catch (e) {
      console.error(e);
      setStatus("Erro ao criar senha: " + e.message, "error");
    }
  });

  // Password strength indicator
  customPasswordInput.addEventListener('input', (e) => {
    const password = e.target.value;
    const result = calculatePasswordStrength(password);
    
    passwordStrengthBar.style.width = result.strength + '%';
    passwordStrengthBar.style.backgroundColor = result.color;
    passwordStrengthText.textContent = result.text;
    passwordStrengthText.style.color = result.color;
  });

  // Search functionality
  searchInput.addEventListener('input', filterPasswords);

  // Make copyToClipboard available globally
  window.copyToClipboard = copyToClipboard;

  // ===== Inicial =====
  setStatus("Aguardando login.");
  updateEmptyState();

  document.getElementById("btn-wallet-export").addEventListener("click", async () => {
  if (!masterPasswordPlain) {
    setStatus("Voc√™ precisa estar logado para exportar a wallet.", "error");
    return;
  }

  setStatus("Exportando wallet...");

  const resp = await apiRequest("/wallet/export", { method: "GET" });
  const data = await resp.json();

  const decryptedEntries = [];

  for (const e of data.entries) {
    const decrypted = await decryptWithMasterPassword(
      e.encrypted_password,
      masterPasswordPlain
    );

    decryptedEntries.push({
      ...e,
      password: decrypted
    });
  }

  const blob = new Blob(
    [JSON.stringify({ version: "1.0", entries: decryptedEntries }, null, 2)],
    { type: "application/json" }
  );

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "wallet.json";
  a.click();

  setStatus("Wallet exportada com sucesso.");
});

document.getElementById("btn-wallet-import").addEventListener("click", () => {
  document.getElementById("wallet-file-input").click();
});

document.getElementById("wallet-file-input").addEventListener("change", async (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const text = await file.text();
  const json = JSON.parse(text);

  const payloadToServer = {
    entries: []
  };

  for (const e of json.entries) {
    const encrypted = await encryptWithMasterPassword(
      e.password,
      masterPasswordPlain
    );

    payloadToServer.entries.push({
      ...e,
      encrypted_password: encrypted
    });
  }

  const resp = await apiRequest("/wallet/import", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payloadToServer)
  });

  const result = await resp.json();
  setStatus(`Wallet importada: ${result.imported} senhas.`);
  loadPasswords();
});

</script>

</body>
</html>