<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciador de Senhas</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #1a202c;
      line-height: 1.6;
    }

    header {
      background: rgba(255, 255, 255, 0.95);
      padding: 1.25rem 2rem;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    #status {
      font-size: 0.875rem;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 8px;
    }

    #status.ok {
      color: #047857;
      background: #d1fae5;
    }

    #status.error {
      color: #dc2626;
      background: #fee2e2;
    }

    main {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 10px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .login-card {
      max-width: 450px;
      margin: 4rem auto;
    }

    .card h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: #1a202c;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #4a5568;
    }

    input[type="text"],
    input[type="password"],
    input[type="number"],
    input[type="datetime-local"] {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 0.938rem;
      background: #f8fafc;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      font-size: 0.875rem;
      color: #4a5568;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 8px;
    }

    .checkbox-label:hover {
      background: #f7fafc;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 0.5rem;
      cursor: pointer;
      accent-color: #667eea;
    }

    button {
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      border: none;
      font-size: 0.938rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
    }

    button.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button.primary:hover {
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }

    button.secondary {
      background: #718096;
      color: white;
    }

    button.secondary:hover {
      background: #4a5568;
    }

    button.danger {
      background: #ef4444;
      color: white;
    }

    button.danger:hover {
      background: #dc2626;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    th {
      background: #f8fafc;
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: #4a5568;
      border-bottom: 2px solid #e2e8f0;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid #f1f5f9;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr {
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    .password-value {
      font-family: 'Monaco', 'Courier New', monospace;
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      display: inline-block;
      margin-top: 0.5rem;
      border: 1px solid #e2e8f0;
      font-size: 0.938rem;
      letter-spacing: 0.5px;
    }

    .small-text {
      font-size: 0.813rem;
      color: #718096;
    }

    .row-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .row-actions button {
      padding: 0.5rem 1rem;
      font-size: 0.813rem;
    }

    .hidden {
      display: none;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge.weak {
      background: #fee2e2;
      color: #dc2626;
    }

    .badge.medium {
      background: #fef3c7;
      color: #d97706;
    }

    .badge.strong {
      background: #d1fae5;
      color: #047857;
    }

    .form-section {
      border: 2px solid #f1f5f9;
      border-radius: 12px;
      padding: 1.5rem;
      background: #fafbfc;
      margin-bottom: 2rem;
    }

    .password-row td {
      background: #f8fafc;
      padding: 1.5rem;
    }

    .copy-btn {
      margin-left: 0.5rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.813rem;
      background: #10b981;
      color: white;
    }

    .copy-btn:hover {
      background: #059669;
    }

    .edit-btn {
      margin-left: 0.5rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.813rem;
      background: #667eea;
      color: white;
    }

    .edit-btn:hover {
      background: #4c51bf;
    }

    .copy-btn.copied {
      background: #6366f1;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #94a3b8;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      opacity: 0.3;
    }

    .search-box {
      margin-bottom: 1.5rem;
    }

    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      background: #f8fafc url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cpath d='m21 21-4.35-4.35'%3E%3C/path%3E%3C/svg%3E") no-repeat 0.75rem center;
    }

    .password-strength-meter {
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      margin-top: 0.5rem;
      overflow: hidden;
    }

    .password-strength-bar {
      height: 100%;
      border-radius: 3px;
    }

    .show-password-btn {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      padding: 0.5rem;
      cursor: pointer;
      color: #718096;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .show-password-btn:hover {
      color: #4a5568;
    }

    .password-input-wrapper {
      position: relative;
    }

    @media (max-width: 768px) {
      header {
        padding: 1rem;
      }

      .header-content h1 {
        font-size: 1.25rem;
      }

      .card {
        padding: 1.5rem;
      }

      .checkbox-group {
        grid-template-columns: 1fr;
      }

      .table-container {
        font-size: 0.813rem;
      }

      th, td {
        padding: 0.75rem 0.5rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>üîê Gerenciador de Senhas</h1>
      <span id="status"></span>
    </div>
  </header>

  <!-- Wallet password modal placeholder (moved to end of body for proper overlay) -->

  <main>
    <!-- Login/Register -->
    <section id="login-section">
      <div class="card login-card">
        <h2 id="form-title">Login</h2>
        <div id="login-form">
          <div class="form-group">
            <label for="username">Usu√°rio</label>
            <input type="text" id="username" placeholder="Seu nome de usu√°rio">
          </div>
          <div class="form-group">
            <label for="password">Senha</label>
            <div class="password-input-wrapper">
              <input type="password" id="password" placeholder="Sua senha">
              <button type="button" class="show-password-btn" id="toggle-password">Mostrar</button>
            </div>
          </div>
          <button class="primary" id="btn-login" style="width: 100%; margin-bottom: 1rem;">Entrar</button>
          <button class="secondary" id="btn-toggle-register" style="width: 100%;">N√£o tem conta? Registre-se</button>
        </div>

        <div id="register-form" class="hidden">
          <div class="form-group">
            <label for="register-username">Usu√°rio</label>
            <input type="text" id="register-username" placeholder="Escolha um nome de usu√°rio (3+ caracteres)">
          </div>
          <div class="form-group">
            <label for="register-email">Email</label>
            <input type="email" id="register-email" placeholder="seu@email.com">
          </div>
          <div class="form-group">
            <label for="register-password">Senha</label>
            <div class="password-input-wrapper">
              <input type="password" id="register-password" placeholder="Senha (8+ caracteres)">
              <button type="button" class="show-password-btn" id="toggle-register-password">Mostrar</button>
            </div>
          </div>
          <button class="primary" id="btn-register" style="width: 100%; margin-bottom: 1rem;">Registrar</button>
          <button class="secondary" id="btn-toggle-login" style="width: 100%;">J√° tem conta? Fa√ßa login</button>
        </div>
      </div>
    </section>

    <!-- App -->
    <section id="app-section" class="hidden">
      <div class="card">
        <div class="top-bar">
          <h2>Bem-vindo <span id="current-username"></span>! üëã </h2>
          <button class="secondary" id="btn-logout">Sair</button>
        </div>

        <!-- Form de cria√ß√£o de senha -->
        <div class="form-section">
          <h2 style="font-size: 1.25rem; margin-bottom: 1rem;">‚ú® Criar nova senha</h2>
          <form id="form-create-password">
            <div class="form-group">
              <label for="title">T√≠tulo</label>
              <input type="text" id="title" required placeholder="Ex.: Gmail pessoal">
            </div>

            <div class="form-group">
              <label for="site">Site / Servi√ßo</label>
              <input type="text" id="site" required placeholder="Ex.: https://mail.google.com">
            </div>

            <div class="form-group">
              <label for="length">Tamanho da senha (se for gerada)</label>
              <input type="number" id="length" min="4" max="128" value="16">
            </div>

            <div class="form-group">
              <label>Caracteres inclu√≠dos</label>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="use-uppercase" checked>
                  Mai√∫sculas (A-Z)
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="use-lowercase" checked>
                  Min√∫sculas (a-z)
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="use-digits" checked>
                  D√≠gitos (0-9)
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="use-special" checked>
                  Especiais (!@#$...)
                </label>
              </div>
            </div>

            <div class="form-group">
              <label for="expiration-date">Data de expira√ß√£o (opcional)</label>
              <input type="datetime-local" id="expiration-date">
            </div>

            <div class="form-group">
              <label for="custom-password">Senha customizada (opcional)</label>
              <input type="text" id="custom-password" placeholder="Deixe vazio para gerar automaticamente">
              <div class="password-strength-meter">
                <div class="password-strength-bar" id="password-strength-bar"></div>
              </div>
              <div id="password-strength-text" class="small-text" style="margin-top: 0.25rem;"></div>
            </div>

            <button type="submit" class="primary">Criar senha</button>
          </form>
        </div>
      </div>

      <!-- Lista de senhas -->
      <div class="card">
        <h2>üîë Senhas salvas</h2>
        <p class="small-text" style="margin-bottom: 1.5rem;">
          A senha descriptografada s√≥ √© mostrada quando voc√™ clica em <strong>Ver</strong>.
        </p>
        
        <div class="search-box">
          <input type="text" id="search-passwords" placeholder="Buscar senhas por t√≠tulo ou site...">
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>T√≠tulo</th>
                <th>Site</th>
                <th>Seguran√ßa</th>
                <th>Expira em</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="passwords-table-body">
              <!-- Linhas preenchidas via JS -->
            </tbody>
          </table>
          <div id="empty-state" class="empty-state hidden">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            <p>Nenhuma senha encontrada</p>
            <p class="small-text">Crie sua primeira senha usando o formul√°rio acima</p>
          </div>
        </div>
      </div>
            <!-- Wallet -->
      <div class="card" style="margin-top: 1.5rem;">
        <h2>üì¶ Wallet (Backup Remoto)</h2>
        <p class="small-text" style="margin-bottom: 1rem;">
          Exporte todas as suas senhas criptografadas para um arquivo ou importe de um arquivo existente.<br>
          O servidor nunca v√™ suas senhas em texto puro.
        </p>

        <div style="display:flex; gap:10px;">
          <button id="btn-wallet-export" class="secondary">Exportar Wallet</button>

          <input type="file" id="wallet-file-input" accept="application/json" style="display:none;">
          <button id="btn-wallet-import" class="secondary">Importar Wallet</button>
        </div>
      </div>

    </section>
  </main>

  <script>
  // ===== Configura√ß√£o =====
  const API_BASE = "http://localhost:8000/api";

  let sessionToken = null;
  let masterPasswordPlain = null;
  let currentUserId = null;
  let currentUsername = null;

  const statusEl = document.getElementById('status');
  const loginSection = document.getElementById('login-section');
  const appSection = document.getElementById('app-section');

  // Login form elements
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  const btnLogin = document.getElementById('btn-login');
  const btnToggleRegister = document.getElementById('btn-toggle-register');
  const togglePasswordBtn = document.getElementById('toggle-password');

  // Register form elements
  const registerUsernameInput = document.getElementById('register-username');
  const registerEmailInput = document.getElementById('register-email');
  const registerPasswordInput = document.getElementById('register-password');
  const btnRegister = document.getElementById('btn-register');
  const btnToggleLogin = document.getElementById('btn-toggle-login');
  const toggleRegisterPasswordBtn = document.getElementById('toggle-register-password');

  const btnLogout = document.getElementById('btn-logout');
  const currentUsernameSpan = document.getElementById('current-username');

  const formCreatePassword = document.getElementById('form-create-password');
  const tbodyPasswords = document.getElementById('passwords-table-body');
  const searchInput = document.getElementById('search-passwords');
  const emptyState = document.getElementById('empty-state');
  const customPasswordInput = document.getElementById('custom-password');
  const passwordStrengthBar = document.getElementById('password-strength-bar');
  const passwordStrengthText = document.getElementById('password-strength-text');

  let allPasswords = [];

  // ===== Helpers de criptografia (NOVOS) =====

  function bytesToBase64(bytes) {
    let binary = "";
    for (let i = 0; i < bytes.length; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  }

  function base64ToBytes(base64) {
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    return bytes;
  }

  async function deriveAesKey(masterPassword, salt, iterations = 300000) {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
      "raw",
      enc.encode(masterPassword),
      { name: "PBKDF2" },
      false,
      ["deriveKey"]
    );

    const key = await crypto.subtle.deriveKey(
      {
        name: "PBKDF2",
        salt: salt,
        iterations: iterations,
        hash: "SHA-256",
      },
      keyMaterial,
      { name: "AES-GCM", length: 256 },
      false,
      ["encrypt", "decrypt"]
    );

    return key;
  }

  async function encryptWithMasterPassword(plaintext, masterPassword) {
    const enc = new TextEncoder();
    const plaintextBytes = enc.encode(plaintext);

    const SALT_SIZE = 16;
    const NONCE_SIZE = 12;
    const TAG_SIZE = 16;

    const salt = crypto.getRandomValues(new Uint8Array(SALT_SIZE));
    const nonce = crypto.getRandomValues(new Uint8Array(NONCE_SIZE));
    const key = await deriveAesKey(masterPassword, salt);

    const cipherBuffer = await crypto.subtle.encrypt(
      {
        name: "AES-GCM",
        iv: nonce,
        tagLength: 128,
      },
      key,
      plaintextBytes
    );

    const cipherBytes = new Uint8Array(cipherBuffer);

    // WebCrypto retorna ciphertext || tag
    const ciphertext = cipherBytes.slice(0, cipherBytes.length - TAG_SIZE);
    const tag = cipherBytes.slice(cipherBytes.length - TAG_SIZE);

    const blob = new Uint8Array(
      salt.length + nonce.length + tag.length + ciphertext.length
    );

    blob.set(salt, 0);
    blob.set(nonce, salt.length);
    blob.set(tag, salt.length + nonce.length);
    blob.set(ciphertext, salt.length + nonce.length + tag.length);

    return bytesToBase64(blob);
  }

  // ===== Wallet-file encryption helpers (AES-GCM with PBKDF2) =====
  async function encryptPayloadWithWalletPassword(plaintextJson, walletPassword, iterations = 300000) {
    const encoder = new TextEncoder();
    const SALT_SIZE = 16;
    const NONCE_SIZE = 12;
    const salt = crypto.getRandomValues(new Uint8Array(SALT_SIZE));
    const nonce = crypto.getRandomValues(new Uint8Array(NONCE_SIZE));

    const key = await deriveAesKey(walletPassword, salt, iterations);

    const cipherBuf = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv: nonce, tagLength: 128 },
      key,
      encoder.encode(plaintextJson)
    );

    const cipherBytes = new Uint8Array(cipherBuf);
    return {
      ciphertext_b64: bytesToBase64(cipherBytes),
      salt_b64: bytesToBase64(salt),
      nonce_b64: bytesToBase64(nonce),
      kdf_iterations: iterations
    };
  }

  async function decryptPayloadWithWalletPassword(ciphertext_b64, walletPassword, salt_b64, nonce_b64, iterations = 300000) {
    const decoder = new TextDecoder();
    const salt = base64ToBytes(salt_b64);
    const nonce = base64ToBytes(nonce_b64);
    const cipherBytes = base64ToBytes(ciphertext_b64);

    const key = await deriveAesKey(walletPassword, salt, iterations);

    const plainBuf = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: nonce, tagLength: 128 },
      key,
      cipherBytes
    );

    return decoder.decode(plainBuf);
  }

  async function decryptWithMasterPassword(base64Blob, masterPassword) {
    const blob = base64ToBytes(base64Blob);

    const SALT_SIZE = 16;
    const NONCE_SIZE = 12;
    const TAG_SIZE = 16;

    let offset = 0;
    const salt = blob.slice(offset, offset + SALT_SIZE);
    offset += SALT_SIZE;

    const nonce = blob.slice(offset, offset + NONCE_SIZE);
    offset += NONCE_SIZE;

    const tag = blob.slice(offset, offset + TAG_SIZE);
    offset += TAG_SIZE;

    const ciphertext = blob.slice(offset);

    const key = await deriveAesKey(masterPassword, salt);

    const cipherPlusTag = new Uint8Array(ciphertext.length + tag.length);
    cipherPlusTag.set(ciphertext, 0);
    cipherPlusTag.set(tag, ciphertext.length);

    const plainBuffer = await crypto.subtle.decrypt(
      {
        name: "AES-GCM",
        iv: nonce,
        tagLength: 128,
      },
      key,
      cipherPlusTag
    );

    return new TextDecoder().decode(plainBuffer);
  }

  function generatePassword(length, useUppercase, useLowercase, useDigits, useSpecial) {
    const UPPERCASE = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const LOWERCASE = "abcdefghijklmnopqrstuvwxyz";
    const DIGITS = "0123456789";
    const SPECIAL = "!@#$%^&*()_+-=[]{}|;:,.<>?";

    let charset = "";
    if (useUppercase) charset += UPPERCASE;
    if (useLowercase) charset += LOWERCASE;
    if (useDigits) charset += DIGITS;
    if (useSpecial) charset += SPECIAL;

    if (!charset) {
      throw new Error("Pelo menos um tipo de caractere deve ser selecionado.");
    }

    const passwordChars = [];

    if (useUppercase) passwordChars.push(UPPERCASE[Math.floor(Math.random() * UPPERCASE.length)]);
    if (useLowercase) passwordChars.push(LOWERCASE[Math.floor(Math.random() * LOWERCASE.length)]);
    if (useDigits) passwordChars.push(DIGITS[Math.floor(Math.random() * DIGITS.length)]);
    if (useSpecial) passwordChars.push(SPECIAL[Math.floor(Math.random() * SPECIAL.length)]);

    while (passwordChars.length < length) {
      const idx = Math.floor(Math.random() * charset.length);
      passwordChars.push(charset[idx]);
    }

    for (let i = passwordChars.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [passwordChars[i], passwordChars[j]] = [passwordChars[j], passwordChars[i]];
    }

    return passwordChars.join("");
  }

  // ===== Helpers =====
  function setStatus(message, type = "ok") {
    statusEl.textContent = message;
    statusEl.className = "";
    if (type === "ok") statusEl.classList.add("ok");
    if (type === "error") statusEl.classList.add("error");
  }

  function showApp() {
    loginSection.classList.add('hidden');
    appSection.classList.remove('hidden');
  }

  function showLogin() {
    appSection.classList.add('hidden');
    loginSection.classList.remove('hidden');
    tbodyPasswords.innerHTML = "";
    allPasswords = [];
    searchInput.value = "";
  }

  async function apiRequest(path, options = {}) {
    const url = API_BASE + path;
    const headers = options.headers || {};
    if (sessionToken) {
      headers['X-Session-Token'] = sessionToken;
    }
    return fetch(url, { ...options, headers });
  }

  function formatDate(isoString) {
    if (!isoString) return "-";
    try {
      const d = new Date(isoString);
      return d.toLocaleString('pt-BR');
    } catch (e) {
      return isoString;
    }
  }

  function getEntropyBadge(level) {
    const levelLower = level.toLowerCase();
    if (levelLower.includes('fraca') || levelLower.includes('weak')) {
      return 'weak';
    } else if (levelLower.includes('m√©dia') || levelLower.includes('medium') || levelLower.includes('moderate')) {
      return 'medium';
    } else {
      return 'strong';
    }
  }

  function calculatePasswordStrength(password) {
    if (!password) return { strength: 0, text: '', color: '' };
    
    let strength = 0;
    
    if (password.length >= 8) strength += 1;
    if (password.length >= 12) strength += 1;
    if (password.length >= 16) strength += 1;
    
    if (/[a-z]/.test(password)) strength += 1;
    if (/[A-Z]/.test(password)) strength += 1;
    if (/[0-9]/.test(password)) strength += 1;
    if (/[^a-zA-Z0-9]/.test(password)) strength += 1;
    
    const normalized = Math.min(strength / 7, 1);
    let text = '';
    let color = '';
    
    if (normalized < 0.3) {
      text = 'Muito fraca';
      color = '#ef4444';
    } else if (normalized < 0.5) {
      text = 'Fraca';
      color = '#f59e0b';
    } else if (normalized < 0.7) {
      text = 'M√©dia';
      color = '#eab308';
    } else if (normalized < 0.9) {
      text = 'Forte';
      color = '#10b981';
    } else {
      text = 'Muito forte';
      color = '#059669';
    }
    
    return { strength: normalized * 100, text, color };
  }

  async function copyToClipboard(text, button) {
    try {
      await navigator.clipboard.writeText(text);
      const originalText = button.textContent;
      button.textContent = 'Copiado!';
      button.classList.add('copied');
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('copied');
      }, 2000);
    } catch (e) {
      console.error('Erro ao copiar:', e);
      setStatus('Erro ao copiar para √°rea de transfer√™ncia', 'error');
    }
  }

  // ===== Wallet password modal helper =====
  function showWalletPasswordModal({ title = 'Senha do Wallet', confirm = false } = {}) {
    return new Promise((resolve) => {
      const modal = document.getElementById('wallet-password-modal');
      const titleEl = document.getElementById('wallet-modal-title');
      const input = document.getElementById('wallet-password-input');
      const confirmContainer = document.getElementById('wallet-password-confirm-container');
      const confirmInput = document.getElementById('wallet-password-confirm');
      const okBtn = document.getElementById('wallet-password-ok');
      const cancelBtn = document.getElementById('wallet-password-cancel');

      titleEl.textContent = title;
      input.value = '';
      confirmInput.value = '';
      confirmContainer.style.display = confirm ? 'block' : 'none';

      // Robustly show the modal: remove 'hidden' class, set display, visibility and opacity
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';

      // Autofocus the input and allow Enter to submit
      setTimeout(() => {
        try { input.focus(); } catch (e) { /* ignore */ }
      }, 20);

      function cleanup() {
        okBtn.removeEventListener('click', onOk);
        cancelBtn.removeEventListener('click', onCancel);
        document.removeEventListener('keydown', onKeyDown);
        modal.style.display = 'none';
        modal.style.visibility = '';
        modal.style.opacity = '';
      }

      function onKeyDown(ev) {
        if (ev.key === 'Enter') {
          onOk();
        } else if (ev.key === 'Escape') {
          onCancel();
        }
      }
      document.addEventListener('keydown', onKeyDown);

      function onOk() {
        const val = input.value;
        if (!val) {
          setStatus('Informe a senha do wallet.', 'error');
          return;
        }
        if (confirm) {
          if (confirmInput.value !== val) {
            setStatus('Senhas n√£o conferem.', 'error');
            return;
          }
        }
        cleanup();
        resolve(val);
      }

      function onCancel() {
        cleanup();
        resolve(null);
      }

      okBtn.addEventListener('click', onOk);
      cancelBtn.addEventListener('click', onCancel);
      input.focus();
    });
  }

  // ===== Confirm modal helper =====
  function showConfirmModal({ title = 'Confirmar', message = 'Tem certeza?' } = {}) {
    return new Promise((resolve) => {
      const modal = document.getElementById('confirm-modal');
      const titleEl = document.getElementById('confirm-modal-title');
      const msgEl = document.getElementById('confirm-modal-message');
      const okBtn = document.getElementById('confirm-ok');
      const cancelBtn = document.getElementById('confirm-cancel');

      titleEl.textContent = title;
      msgEl.textContent = message;

      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';

      function cleanup() {
        okBtn.removeEventListener('click', onOk);
        cancelBtn.removeEventListener('click', onCancel);
        document.removeEventListener('keydown', onKeyDown);
        modal.style.display = 'none';
        modal.style.visibility = '';
      }

      function onKeyDown(ev) {
        if (ev.key === 'Enter') onOk();
        if (ev.key === 'Escape') onCancel();
      }
      document.addEventListener('keydown', onKeyDown);

      function onOk() { cleanup(); resolve(true); }
      function onCancel() { cleanup(); resolve(false); }

      okBtn.addEventListener('click', onOk);
      cancelBtn.addEventListener('click', onCancel);
    });
  }

  // ===== Edit-password modal helper =====
  function showEditPasswordModal(entry) {
    return new Promise((resolve) => {
      const modal = document.getElementById('edit-password-modal');
      const titleEl = document.getElementById('edit-modal-title');
      const inputTitle = document.getElementById('edit-title');
      const inputSite = document.getElementById('edit-site');
      const inputPassword = document.getElementById('edit-password-input');
      const inputExpiration = document.getElementById('edit-expiration');
      const okBtn = document.getElementById('edit-password-ok');
      const cancelBtn = document.getElementById('edit-password-cancel');

      titleEl.textContent = 'Editar senha';
      inputTitle.value = entry.title || '';
      inputSite.value = entry.site || '';
      inputPassword.value = entry._decrypted_preview || '';
      inputExpiration.value = entry.expiration_date ? (new Date(entry.expiration_date)).toISOString().slice(0,16) : '';

      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';

      function cleanup() {
        okBtn.removeEventListener('click', onOk);
        cancelBtn.removeEventListener('click', onCancel);
        document.removeEventListener('keydown', onKeyDown);
        modal.style.display = 'none';
        modal.style.visibility = '';
      }

      function onKeyDown(ev) {
        if (ev.key === 'Enter') onOk();
        if (ev.key === 'Escape') onCancel();
      }
      document.addEventListener('keydown', onKeyDown);

      function onOk() {
        const val = inputPassword.value;
        const t = inputTitle.value.trim();
        const s = inputSite.value.trim();
        const exp = inputExpiration.value ? new Date(inputExpiration.value).toISOString() : null;
        if (!t || !s) { setStatus('T√≠tulo e site s√£o obrigat√≥rios.', 'error'); return; }
        cleanup();
        resolve({ title: t, site: s, password: val, expiration_date: exp });
      }

      function onCancel() { cleanup(); resolve(null); }

      okBtn.addEventListener('click', onOk);
      cancelBtn.addEventListener('click', onCancel);

      // focus
      setTimeout(() => inputPassword.focus(), 20);
    });
  }

  function updateEmptyState() {
    const hasRows = tbodyPasswords.children.length > 0;
    if (hasRows) {
      emptyState.classList.add('hidden');
    } else {
      emptyState.classList.remove('hidden');
    }
  }

  function filterPasswords() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    tbodyPasswords.innerHTML = ''; // garante que limpa sempre

    if (!searchTerm) {
      allPasswords.forEach(entry => addPasswordRow(entry));
      updateEmptyState();
      return;
    }
    
    const filtered = allPasswords.filter(entry => 
      entry.title.toLowerCase().includes(searchTerm) ||
      entry.site.toLowerCase().includes(searchTerm)
    );
    
    filtered.forEach(entry => addPasswordRow(entry));
    updateEmptyState();
  }

  // ===== Login / Logout =====
  
  // Toggle between login and register forms
  btnToggleRegister.addEventListener('click', () => {
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('register-form').classList.remove('hidden');
    document.getElementById('form-title').textContent = 'Registrar';
  });

  btnToggleLogin.addEventListener('click', () => {
    document.getElementById('register-form').classList.add('hidden');
    document.getElementById('login-form').classList.remove('hidden');
    document.getElementById('form-title').textContent = 'Login';
  });

  // Toggle password visibility
  togglePasswordBtn.addEventListener('click', () => {
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      togglePasswordBtn.textContent = 'Ocultar';
    } else {
      passwordInput.type = 'password';
      togglePasswordBtn.textContent = 'Mostrar';
    }
  });

  toggleRegisterPasswordBtn.addEventListener('click', () => {
    if (registerPasswordInput.type === 'password') {
      registerPasswordInput.type = 'text';
      toggleRegisterPasswordBtn.textContent = 'Ocultar';
    } else {
      registerPasswordInput.type = 'password';
      toggleRegisterPasswordBtn.textContent = 'Mostrar';
    }
  });

  // Register
  btnRegister.addEventListener('click', async () => {
    const username = registerUsernameInput.value.trim();
    const email = registerEmailInput.value.trim();
    const password = registerPasswordInput.value.trim();

    if (!username || !email || !password) {
      setStatus("Preencha todos os campos.", "error");
      return;
    }

    btnRegister.disabled = true;
    setStatus("Registrando...");

    try {
      const resp = await fetch(API_BASE + "/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, email, password })
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.detail || "Erro no registro");
      }

      setStatus("Registro realizado com sucesso! Fa√ßa login.");
      registerUsernameInput.value = "";
      registerEmailInput.value = "";
      registerPasswordInput.value = "";
      
      // Volta para login
      document.getElementById('register-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('form-title').textContent = 'Login';
    } catch (e) {
      console.error(e);
      setStatus("Erro no registro: " + e.message, "error");
    } finally {
      btnRegister.disabled = false;
    }
  });

  // Login
  usernameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') btnLogin.click();
  });

  passwordInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') btnLogin.click();
  });

  btnLogin.addEventListener('click', async () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();

    if (!username || !password) {
      setStatus("Digite username e senha.", "error");
      return;
    }

    btnLogin.disabled = true;
    setStatus("Fazendo login...");

    try {
      const resp = await fetch(API_BASE + "/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.detail || "Falha no login");
      }

      const data = await resp.json();
      sessionToken = data.token;
      currentUserId = data.user_id;
      currentUsername = data.username;
      
      // Usa a senha como master password para descriptografar no cliente
      masterPasswordPlain = password;

      setStatus("Login realizado com sucesso.");
      usernameInput.value = "";
      passwordInput.value = "";
      currentUsernameSpan.textContent = currentUsername;
      showApp();
      await loadPasswords();
    } catch (e) {
      console.error(e);
      setStatus("Erro no login: " + e.message, "error");
    } finally {
      btnLogin.disabled = false;
    }
  });

  // Logout
  btnLogout.addEventListener('click', async () => {
    if (!sessionToken) {
      showLogin();
      setStatus("Sess√£o encerrada.");
      return;
    }

    try {
      await apiRequest("/auth/logout", {
        method: "POST"
      });
    } catch (e) {
      console.warn("Erro no logout (ignorado):", e);
    } finally {
      sessionToken = null;
      masterPasswordPlain = null;
      currentUserId = null;
      currentUsername = null;
      currentUsernameSpan.textContent = "";
      showLogin();
      setStatus("Sess√£o encerrada.");
    }
  });

  // ===== CRUD de Senhas =====
  async function loadPasswords() {
    if (!sessionToken) return;

    setStatus("Carregando senhas...");
    tbodyPasswords.innerHTML = "";
    allPasswords = [];

    try {
      const resp = await apiRequest("/passwords", {
        method: "GET"
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.detail || "Erro ao listar senhas");
      }

      const data = await resp.json();
      if (!Array.isArray(data)) {
        throw new Error("Resposta inesperada do servidor.");
      }

      allPasswords = data;
      data.forEach(entry => addPasswordRow(entry));
      updateEmptyState();
      setStatus("Senhas carregadas.");
    } catch (e) {
      console.error(e);
      setStatus("Erro ao carregar senhas: " + e.message, "error");
      updateEmptyState();
    }
  }

  function addPasswordRow(entry) {
    const tr = document.createElement('tr');
    tr.dataset.id = entry.id;

    const tdId = document.createElement('td');
    tdId.textContent = entry.id;

    const tdTitle = document.createElement('td');
    tdTitle.textContent = entry.title;

    const tdSite = document.createElement('td');
    tdSite.textContent = entry.site;

    const tdEntropy = document.createElement('td');
    const badgeClass = getEntropyBadge(entry.entropy_level);
    tdEntropy.innerHTML = `
      <div>${entry.entropy} bits</div>
      <span class="badge ${badgeClass}">${entry.entropy_level}</span>
    `;

    const tdExp = document.createElement('td');
    tdExp.textContent = formatDate(entry.expiration_date);

    const tdActions = document.createElement('td');
    const actionsDiv = document.createElement('div');
    actionsDiv.className = "row-actions";

    const btnView = document.createElement('button');
    btnView.textContent = "Ver";
    btnView.className = "secondary";
    btnView.addEventListener('click', () => viewPassword(entry.id, tr));

    const btnDelete = document.createElement('button');
    btnDelete.textContent = "Excluir";
    btnDelete.className = "danger";
    btnDelete.addEventListener('click', () => deletePassword(entry.id, tr));

    actionsDiv.appendChild(btnView);
    actionsDiv.appendChild(btnDelete);
    tdActions.appendChild(actionsDiv);

    tr.appendChild(tdId);
    tr.appendChild(tdTitle);
    tr.appendChild(tdSite);
    tr.appendChild(tdEntropy);
    tr.appendChild(tdExp);
    tr.appendChild(tdActions);

    tbodyPasswords.appendChild(tr);
  }

  async function viewPassword(id, row) {
    try {
      // Toggle: if detail row exists, remove it ("unsee")
      const existing = row.nextElementSibling;
      const viewBtn = row.querySelector('.secondary');
      if (existing && existing.classList && existing.classList.contains('password-row')) {
        existing.remove();
        if (viewBtn) viewBtn.textContent = 'Ver';
        setStatus('Visualiza√ß√£o fechada.');
        return;
      }

      if (!masterPasswordPlain) {
        setStatus("Senha mestra n√£o est√° dispon√≠vel no cliente.", "error");
        return;
      }

      setStatus("Carregando senha...");
      const resp = await apiRequest(`/passwords/${id}`, {
        method: "GET"
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.detail || "Erro ao obter senha");
      }

      const data = await resp.json();

      // *** NOVO: senha vem criptografada -> descriptografar no cliente
      let decrypted;
      try {
        decrypted = await decryptWithMasterPassword(data.encrypted_password, masterPasswordPlain);
      } catch (e) {
        console.error(e);
        setStatus("Erro ao descriptografar a senha no cliente: " + e.message, "error");
        return;
      }

      setStatus("Senha carregada.");

      // Store a quick decrypted preview on the in-memory entry for later edits
      try {
        const entryObj = allPasswords.find(p => p.id === id);
        if (entryObj) entryObj._decrypted_preview = decrypted;
      } catch (e) { /* ignore */ }
      // remove any previous detail row just in case (we already checked above)
      const prev = row.nextElementSibling;
      if (prev && prev.classList && prev.classList.contains("password-row")) {
        prev.remove();
      }

      const tr = document.createElement('tr');
      tr.className = "password-row";

      const td = document.createElement('td');
      td.colSpan = 6;

      const escaped = decrypted.replace(/'/g, "\\'");

      td.innerHTML = `
        <div>
          <strong>Senha:</strong>
          <div class="password-value">
            ${decrypted}
            <button class="copy-btn" onclick="copyToClipboard('${escaped}', this)"> Copiar</button>
          </div>
        </div>
      `;

      tr.appendChild(td);
      row.parentNode.insertBefore(tr, row.nextSibling);

      // Add an Edit button under the revealed password
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Editar';
      editBtn.className = 'edit-btn';
      editBtn.style.marginLeft = '0.5rem';
      editBtn.addEventListener('click', () => startEditPassword(id));

      // append edit button next to copy button
      const pwValEl = td.querySelector('.password-value');
      if (pwValEl) pwValEl.appendChild(editBtn);

      if (viewBtn) viewBtn.textContent = 'Esconder';

    } catch (e) {
      console.error(e);
      setStatus("Erro ao obter senha: " + e.message, "error");
    }
  }

  async function deletePassword(id, row) {
  const ok = await showConfirmModal({ title: 'Confirmar exclus√£o', message: 'Tem certeza que deseja excluir esta senha?' });
  if (!ok) {
    return;
  }

  try {
    setStatus("Excluindo senha...");
    const resp = await apiRequest(`/passwords/${id}`, {
      method: "DELETE"
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.detail || "Erro ao deletar senha");
    }

    // pega a linha de detalhe ANTES de remover a principal
    const extra = row.nextElementSibling;
    if (extra && extra.classList.contains("password-row")) {
      extra.remove();
    }

    // remove a linha principal
    row.remove();

    // Remove do array local
    allPasswords = allPasswords.filter(p => p.id !== id);

    updateEmptyState();

    const data = await resp.json().catch(() => null);
    setStatus(data?.message || "Senha deletada com sucesso.");
  } catch (e) {
    console.error(e);
    setStatus("Erro ao deletar senha: " + e.message, "error");
  }
}

// ===== Start edit flow for a password =====
async function startEditPassword(id) {
  if (!masterPasswordPlain) {
    setStatus("Senha mestra n√£o est√° dispon√≠vel no cliente.", "error");
    return;
  }

  const entry = allPasswords.find(p => p.id === id);
  if (!entry) {
    setStatus('Entrada n√£o encontrada.', 'error');
    return;
  }

  // Ensure we have a decrypted preview for the password (used to prefill the modal)
  try {
    if (!entry._decrypted_preview) {
      const resp = await apiRequest(`/passwords/${id}`, { method: 'GET' });
      if (!resp.ok) throw new Error('Erro ao buscar senha para edi√ß√£o');
      const data = await resp.json();
      entry._decrypted_preview = await decryptWithMasterPassword(data.encrypted_password, masterPasswordPlain);
    }
  } catch (e) {
    console.error(e);
    setStatus('Erro ao obter senha para edi√ß√£o: ' + e.message, 'error');
    return;
  }

  const result = await showEditPasswordModal(entry);
  if (!result) {
    setStatus('Edi√ß√£o cancelada pelo usu√°rio.');
    return;
  }

  setStatus('Criptografando nova senha...');
  let encryptedBase64;
  try {
    encryptedBase64 = await encryptWithMasterPassword(result.password || '', masterPasswordPlain);
  } catch (e) {
    console.error(e);
    setStatus('Erro ao criptografar nova senha: ' + e.message, 'error');
    return;
  }

  const payload = {
    title: result.title,
    site: result.site,
    length: entry.length || 0,
    use_uppercase: entry.use_uppercase,
    use_lowercase: entry.use_lowercase,
    use_digits: entry.use_digits,
    use_special: entry.use_special,
    expiration_date: result.expiration_date,
    encrypted_password: encryptedBase64
  };

  try {
    setStatus('Atualizando senha no servidor...');
    const resp = await apiRequest(`/passwords/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.detail || 'Erro ao atualizar senha');
    }

    const updated = await resp.json().catch(() => null);

    // Update local array
    entry.title = payload.title;
    entry.site = payload.site;
    entry.expiration_date = payload.expiration_date;
    entry.encrypted_password = payload.encrypted_password;
    entry._decrypted_preview = result.password || '';

    // Update DOM row
    const rows = Array.from(tbodyPasswords.querySelectorAll('tr'));
    for (const r of rows) {
      if (String(r.dataset.id) === String(id)) {
        const tds = r.children;
        if (tds[1]) tds[1].textContent = entry.title;
        if (tds[2]) tds[2].textContent = entry.site;
        if (tds[4]) tds[4].textContent = formatDate(entry.expiration_date);
        break;
      }
    }

    // If detail row is open, update displayed password
    const mainRow = tbodyPasswords.querySelector(`tr[data-id="${id}"]`);
    if (mainRow) {
      const detail = mainRow.nextElementSibling;
      if (detail && detail.classList && detail.classList.contains('password-row')) {
        const pwDiv = detail.querySelector('.password-value');
        if (pwDiv) {
          const escaped = (entry._decrypted_preview || '').replace(/'/g, "\\'");
          pwDiv.innerHTML = `${entry._decrypted_preview}<button class="copy-btn" onclick="copyToClipboard('${escaped}', this)"> Copiar</button>`;
          // add edit button back
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Editar';
          editBtn.className = 'primary';
          editBtn.style.marginLeft = '0.5rem';
          editBtn.addEventListener('click', () => startEditPassword(id));
          pwDiv.appendChild(editBtn);
        }
      }
    }

    setStatus('Senha atualizada com sucesso.');
  } catch (e) {
    console.error(e);
    setStatus('Erro ao atualizar senha: ' + e.message, 'error');
  }
}


  // ===== Form de cria√ß√£o de senha =====
  formCreatePassword.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!sessionToken) {
      setStatus("Voc√™ precisa estar logado.", "error");
      return;
    }
    if (!masterPasswordPlain) {
      setStatus("Senha mestra n√£o est√° dispon√≠vel no cliente.", "error");
      return;
    }

    const title = document.getElementById('title').value.trim();
    const site = document.getElementById('site').value.trim();
    let length = parseInt(document.getElementById('length').value, 10) || 16;
    const useUppercase = document.getElementById('use-uppercase').checked;
    const useLowercase = document.getElementById('use-lowercase').checked;
    const useDigits = document.getElementById('use-digits').checked;
    const useSpecial = document.getElementById('use-special').checked;
    const expirationInput = document.getElementById('expiration-date').value;
    const customPassword = document.getElementById('custom-password').value.trim() || null;

    let plainPassword;
    if (customPassword) {
      plainPassword = customPassword;
      length = customPassword.length;
    } else {
      try {
        plainPassword = generatePassword(length, useUppercase, useLowercase, useDigits, useSpecial);
      } catch (e) {
        setStatus(e.message, "error");
        return;
      }
    }

    setStatus("Criptografando senha no cliente...");

    let encryptedBase64;
    try {
      encryptedBase64 = await encryptWithMasterPassword(plainPassword, masterPasswordPlain);
    } catch (e) {
      console.error(e);
      setStatus("Erro ao criptografar a senha no cliente: " + e.message, "error");
      return;
    }

    const payload = {
      title,
      site,
      length,
      use_uppercase: useUppercase,
      use_lowercase: useLowercase,
      use_digits: useDigits,
      use_special: useSpecial,
      expiration_date: expirationInput ? new Date(expirationInput).toISOString() : null,
      custom_password: null,                 // *** deixa de mandar texto puro
      encrypted_password: encryptedBase64    // *** NOVO
    };

    setStatus("Criando senha...");

    try {
      const resp = await apiRequest("/passwords", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.detail || "Erro ao criar senha");
      }

      const data = await resp.json();
      addPasswordRow(data);
      allPasswords.push(data);
      formCreatePassword.reset();
      document.getElementById('length').value = 16;
      document.getElementById('use-uppercase').checked = true;
      document.getElementById('use-lowercase').checked = true;
      document.getElementById('use-digits').checked = true;
      document.getElementById('use-special').checked = true;
      passwordStrengthBar.style.width = '0%';
      passwordStrengthText.textContent = '';
      updateEmptyState();
      setStatus("Senha criada com sucesso.");
    } catch (e) {
      console.error(e);
      setStatus("Erro ao criar senha: " + e.message, "error");
    }
  });

  // Password strength indicator
  customPasswordInput.addEventListener('input', (e) => {
    const password = e.target.value;
    const result = calculatePasswordStrength(password);
    
    passwordStrengthBar.style.width = result.strength + '%';
    passwordStrengthBar.style.backgroundColor = result.color;
    passwordStrengthText.textContent = result.text;
    passwordStrengthText.style.color = result.color;
  });

  // Search functionality
  searchInput.addEventListener('input', filterPasswords);

  // Make copyToClipboard available globally
  window.copyToClipboard = copyToClipboard;

  // ===== Inicial =====
  setStatus("Aguardando login.");
  updateEmptyState();

  document.getElementById("btn-wallet-export").addEventListener("click", async () => {
    if (!masterPasswordPlain) {
      setStatus("Voc√™ precisa estar logado para exportar a wallet.", "error");
      return;
    }

    setStatus("Preparando exporta√ß√£o da wallet...");

    // Fetch server-side listing (contains encrypted entries)
    const resp = await apiRequest("/wallet/export", { method: "GET" });
    const data = await resp.json();

    // Decrypt each entry locally and build a plain payload
    const decryptedEntries = [];
    for (const e of data.entries) {
      const decrypted = await decryptWithMasterPassword(e.encrypted_password, masterPasswordPlain);
      decryptedEntries.push({
        title: e.title,
        site: e.site,
        password: decrypted,
        length: e.length,
        use_uppercase: e.use_uppercase,
        use_lowercase: e.use_lowercase,
        use_digits: e.use_digits,
        use_special: e.use_special,
        entropy: e.entropy,
        expiration_date: e.expiration_date,
        created_at: e.created_at,
        updated_at: e.updated_at
      });
    }

    const payload = { version: "1.0", entries: decryptedEntries };

    // Serialize payload
    const payloadJson = JSON.stringify(payload, null, 2);

    // Ask the user for a wallet password via modal (confirm required)
    const walletPassword = await showWalletPasswordModal({ title: 'Escolha uma senha para o arquivo wallet', confirm: true });
    if (!walletPassword) {
      setStatus('Exporta√ß√£o cancelada pelo usu√°rio.', 'error');
      return;
    }

    setStatus('Criptografando payload do wallet...');

    // Encrypt the payload using the wallet password (AES-GCM)
    const encResult = await encryptPayloadWithWalletPassword(payloadJson, walletPassword, 300000);

    // Build metadata describing the wallet and the entry schema (encrypted)
    const meta = {
      wallet_format_version: "1.0",
      app: { name: "password-managment", version: "1.0" },
      exported_at: new Date().toISOString(),
      encryption: {
        algorithm: "AES-GCM",
        kdf: "PBKDF2",
        kdf_hash: "SHA-256",
        kdf_iterations: encResult.kdf_iterations,
        salt: encResult.salt_b64,
        nonce: encResult.nonce_b64,
        tag_bytes: 16,
      },
      serialization: { format: "json", encoding: "utf-8", indent: 2 }
    };

    const walletFile = {
      meta,
      data: {
        entries_encrypted: encResult.ciphertext_b64
      }
    };

    const blob = new Blob([JSON.stringify(walletFile, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "wallet.json";
    a.click();

    setStatus("Wallet exportada com sucesso.");
  });

document.getElementById("btn-wallet-import").addEventListener("click", () => {
  document.getElementById("wallet-file-input").click();
});

document.getElementById("wallet-file-input").addEventListener("change", async (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const text = await file.text();
  const json = JSON.parse(text);

  // Accept both older flat format ({ entries: [...] }), legacy new plain format ({ meta, data.entries }),
  // and encrypted wallet format ({ meta, data.entries_encrypted }).
  let entriesSource = null;
  if (json && json.data && json.data.entries_encrypted) {
    // Encrypted wallet file produced by export flow
    try {
      const walletPassword = await showWalletPasswordModal({ title: 'Digite a senha do wallet para importar', confirm: false });
      if (!walletPassword) {
        setStatus('Importa√ß√£o cancelada pelo usu√°rio.', 'error');
        return;
      }

      const encMeta = json.meta && json.meta.encryption ? json.meta.encryption : {};
      const iterations = encMeta.kdf_iterations || 300000;
      const salt_b64 = encMeta.salt;
      const nonce_b64 = encMeta.nonce;

      if (!salt_b64 || !nonce_b64) {
        setStatus('Formato de wallet inv√°lido: metadados de criptografia ausentes.', 'error');
        return;
      }

      const plaintext = await decryptPayloadWithWalletPassword(json.data.entries_encrypted, walletPassword, salt_b64, nonce_b64, iterations);
      const parsed = JSON.parse(plaintext);
      if (!parsed || !Array.isArray(parsed.entries)) {
        setStatus('Arquivo de wallet descriptografado mas formato inv√°lido.', 'error');
        return;
      }

      entriesSource = parsed.entries;
    } catch (e) {
      console.error('Erro ao descriptografar wallet:', e);
      setStatus('Erro ao descriptografar o arquivo do wallet: senha incorreta ou arquivo inv√°lido.', 'error');
      return;
    }
  } else if (json && json.data && Array.isArray(json.data.entries)) {
    // new plain format (may include HMAC signature)
    if (json.hmac && json.meta && json.meta.hmac) {
      try {
        const walletPassword = await showWalletPasswordModal({ title: 'Digite a senha do wallet para verificar assinatura', confirm: false });
        if (!walletPassword) {
          setStatus('Importa√ß√£o cancelada pelo usu√°rio.', 'error');
          return;
        }

        const encoder = new TextEncoder();
        const salt = base64ToBytes(json.meta.hmac.salt);
        const iterations = json.meta.hmac.kdf_iterations || 300000;
        const pwKey = await crypto.subtle.importKey('raw', encoder.encode(walletPassword), { name: 'PBKDF2' }, false, ['deriveKey']);
        const hmacKey = await crypto.subtle.deriveKey(
          { name: 'PBKDF2', salt: salt, iterations: iterations, hash: 'SHA-256' },
          pwKey,
          { name: 'HMAC', hash: 'SHA-256' },
          false,
          ['verify']
        );

        const payloadJson = JSON.stringify(json.data, null, 2);
        const sig = base64ToBytes(json.hmac);
        const ok = await crypto.subtle.verify('HMAC', hmacKey, sig, encoder.encode(payloadJson));
        if (!ok) {
          setStatus('HMAC inv√°lido: arquivo corrompido ou senha do wallet incorreta.', 'error');
          return;
        }
      } catch (e) {
        console.error('Erro ao verificar HMAC:', e);
        setStatus('Erro ao verificar assinatura do arquivo.', 'error');
        return;
      }
    }

    entriesSource = json.data.entries;
  } else if (json && Array.isArray(json.entries)) {
    // legacy format
    entriesSource = json.entries;
  } else {
    setStatus('Formato de wallet desconhecido.', 'error');
    return;
  }

  const payloadToServer = { entries: [] };
  for (const e of entriesSource) {
    const encrypted = await encryptWithMasterPassword(e.password, masterPasswordPlain);
    payloadToServer.entries.push({
      title: e.title,
      site: e.site,
      length: e.length,
      use_uppercase: e.use_uppercase,
      use_lowercase: e.use_lowercase,
      use_digits: e.use_digits,
      use_special: e.use_special,
      entropy: e.entropy,
      expiration_date: e.expiration_date,
      created_at: e.created_at,
      updated_at: e.updated_at,
      encrypted_password: encrypted
    });
  }

  const resp = await apiRequest("/wallet/import", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payloadToServer)
  });

  const result = await resp.json();
  setStatus(`Wallet importada: ${result.imported || result.message || 'ok'} senhas.`);
  await loadPasswords();
});

</script>

  <!-- Wallet password modal (placed at end for correct stacking) -->
  <!-- Confirm delete modal -->
  <div id="confirm-modal" class="hidden" role="dialog" aria-modal="true" style="position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:10000;display:none;">
    <div style="background:white;padding:1rem;border-radius:12px;min-width:300px;max-width:520px;box-shadow:0 16px 48px rgba(2,6,23,0.4);">
      <h3 id="confirm-modal-title" style="margin-bottom:0.5rem;font-size:1.05rem;">Confirmar</h3>
      <div id="confirm-modal-message" style="margin-bottom:0.75rem;color:#374151;"></div>
      <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
        <button id="confirm-cancel" class="secondary">Cancelar</button>
        <button id="confirm-ok" class="danger">Excluir</button>
      </div>
    </div>
  </div>

  <!-- Edit password modal -->
  <div id="edit-password-modal" class="hidden" role="dialog" aria-modal="true" style="position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:10001;display:none;">
    <div style="background:white;padding:1.25rem;border-radius:12px;min-width:320px;max-width:640px;box-shadow:0 16px 48px rgba(2,6,23,0.4);">
      <h3 id="edit-modal-title" style="margin-bottom:0.5rem;font-size:1.05rem;">Editar senha</h3>
      <div style="margin-bottom:0.5rem;">
        <label for="edit-title" style="display:block;margin-bottom:0.25rem;">T√≠tulo</label>
        <input id="edit-title" type="text" style="width:100%;padding:0.5rem;border:1px solid #e2e8f0;border-radius:8px;" />
      </div>
      <div style="margin-bottom:0.5rem;">
        <label for="edit-site" style="display:block;margin-bottom:0.25rem;">Site</label>
        <input id="edit-site" type="text" style="width:100%;padding:0.5rem;border:1px solid #e2e8f0;border-radius:8px;" />
      </div>
      <div style="margin-bottom:0.5rem;">
        <label for="edit-password-input" style="display:block;margin-bottom:0.25rem;">Senha</label>
        <input id="edit-password-input" type="text" style="width:100%;padding:0.5rem;border:1px solid #e2e8f0;border-radius:8px;" />
      </div>
      <div style="margin-bottom:0.75rem;">
        <label for="edit-expiration" style="display:block;margin-bottom:0.25rem;">Data de expira√ß√£o (opcional)</label>
        <input id="edit-expiration" type="datetime-local" style="width:100%;padding:0.5rem;border:1px solid #e2e8f0;border-radius:8px;" />
      </div>
      <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
        <button id="edit-password-cancel" class="secondary">Cancelar</button>
        <button id="edit-password-ok" class="primary">Salvar</button>
      </div>
    </div>
  </div>
  <div id="wallet-password-modal" class="hidden" role="dialog" aria-modal="true" style="position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:9999;display:none;">
    <div style="background:white;padding:1.25rem;border-radius:12px;min-width:320px;max-width:520px;box-shadow:0 16px 48px rgba(2,6,23,0.4);">
      <h3 id="wallet-modal-title" style="margin-bottom:0.5rem;font-size:1.05rem;">Senha do Wallet</h3>
      <div style="margin-bottom:0.75rem;">
        <label for="wallet-password-input" style="display:block;margin-bottom:0.25rem;">Senha do wallet</label>
        <input id="wallet-password-input" type="password" style="width:100%;padding:0.5rem;border:1px solid #e2e8f0;border-radius:8px;" />
      </div>
      <div id="wallet-password-confirm-container" style="display:none;margin-bottom:0.75rem;">
        <label for="wallet-password-confirm" style="display:block;margin-bottom:0.25rem;">Confirme a senha</label>
        <input id="wallet-password-confirm" type="password" style="width:100%;padding:0.5rem;border:1px solid #e2e8f0;border-radius:8px;" />
      </div>
      <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
        <button id="wallet-password-cancel" class="secondary">Cancelar</button>
        <button id="wallet-password-ok" class="primary">OK</button>
      </div>
    </div>
  </div>

</body>
</html>